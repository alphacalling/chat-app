// Generator
generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

// Datasource
datasource db {
  provider = "postgresql"
}

model User {
  id       String   @id @default(cuid())
  phone    String   @unique
  name     String
  email    String?  @unique
  password String
  avatar   String?
  about    String   @default("Hey there! I'm using Chit-Chat")
  gender   String?
  isOnline Boolean  @default(false)
  lastSeen DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshToken String?
  
  // TOTP Authentication
  totpSecret    String?
  totpEnabled   Boolean  @default(false)
  totpBackupCodes String?

  sentMessages    Message[]         @relation("SentMessages")
  chats           ChatParticipant[]
  blockedUsers    BlockedUser[]     @relation("BlockedBy")
  blockedBy       BlockedUser[]     @relation("Blocked")
  statuses        Status[]
  statusViews     StatusView[]
  statusReactions StatusReaction[]
  messageReactions MessageReaction[]

  @@index([phone])
  @@index([email])
}

model Chat {
  id      String  @id @default(cuid())
  name    String?
  isGroup Boolean @default(false)
  avatar  String?
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ChatParticipant[]
  messages     Message[]
  inviteLinks  InviteLink[]
}

model ChatParticipant {
  id       String   @id @default(cuid())
  role     Role     @default(MEMBER)
  joinedAt DateTime @default(now())

  userId String
  chatId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
}

model Message {
  id       String        @id @default(cuid())
  content  String?
  type     MessageType   @default(TEXT)
  mediaUrl String?
  fileName String?
  fileSize Int?
  mimeType String?
  status   MessageStatus @default(SENT)
  isEdited Boolean       @default(false)
  editedAt DateTime?
  pinnedAt DateTime?

  createdAt   DateTime  @default(now())
  deliveredAt DateTime?
  readAt      DateTime?

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)

  replyToId String?
  replyTo   Message?  @relation("Replies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("Replies")
  
  reactions MessageReaction[]

  @@index([chatId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([pinnedAt])
}

enum Role {
  ADMIN
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model BlockedUser {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  
  blocker User @relation("BlockedBy", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model MessageReaction {
  id        String   @id @default(cuid())
  emoji     String
  messageId String
  userId    String
  
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model InviteLink {
  id        String   @id @default(cuid())
  chatId    String
  code      String   @unique
  createdBy String
  expiresAt DateTime?
  maxUses   Int?
  useCount  Int      @default(0)
  isActive  Boolean  @default(true)
  
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([code])
  @@index([chatId])
}

model Status {
  id        String   @id @default(cuid())
  userId    String
  content   String?
  mediaUrl  String?
  type      StatusType @default(TEXT)
  expiresAt DateTime
  
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  views    StatusView[]
  reactions StatusReaction[]
  
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
}

model StatusView {
  id       String   @id @default(cuid())
  statusId String
  userId   String
  
  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  viewedAt DateTime @default(now())
  
  @@unique([statusId, userId])
  @@index([statusId])
  @@index([userId])
}

model StatusReaction {
  id       String   @id @default(cuid())
  statusId String
  userId   String
  emoji    String
  
  status Status @relation(fields: [statusId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([statusId, userId])
  @@index([statusId])
  @@index([userId])
}

enum StatusType {
  TEXT
  IMAGE
  VIDEO
}
